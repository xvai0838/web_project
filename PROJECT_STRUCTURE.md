# é¡¹ç›®æ¶æ„è¯¦è§£

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (Vue 3 + Vite)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WelcomePage  â”‚  LoginPage  â”‚  ProfilePage  â”‚  AnalysisPage â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Vue Router (è·¯ç”±ç®¡ç†)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         api.js (AIåˆ†æ)    â”‚    userApi.js (ç”¨æˆ·è®¤è¯)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ (Express + SQLite)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·è®¤è¯  â”‚  ç”¨æˆ·ä¿¡æ¯ç®¡ç†  â”‚  å†å²è®°å½•ç®¡ç†  â”‚  ä¼šè¯ç®¡ç†       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤–éƒ¨æœåŠ¡                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              è±†åŒ…è§†è§‰æ¨¡å‹ API (å›¾ç‰‡åˆ†æ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–‡ä»¶è¯¦è§£

### é…ç½®æ–‡ä»¶

#### `package.json`
å‰ç«¯é¡¹ç›®é…ç½®ï¼Œå®šä¹‰äº†ï¼š
- é¡¹ç›®åç§°å’Œç‰ˆæœ¬
- npm è„šæœ¬å‘½ä»¤ (dev/build/preview/test)
- ä¾èµ–ï¼šVue 3ã€Vue Router
- å¼€å‘ä¾èµ–ï¼šViteã€Vitestã€jsdom

#### `vite.config.js`
Vite æ„å»ºå·¥å…·é…ç½®ï¼š
- Vue æ’ä»¶æ”¯æŒ
- è·¯å¾„åˆ«å (`@` -> `/src`)
- æµ‹è¯•ç¯å¢ƒé…ç½® (jsdom)

#### `index.html`
åº”ç”¨å…¥å£ HTMLï¼š
- å¼•å…¥ Font Awesome å›¾æ ‡åº“
- å¼•å…¥å…¨å±€æ ·å¼
- Vue åº”ç”¨æŒ‚è½½ç‚¹ `#app`

#### `style.css`
å…¨å±€ CSS æ ·å¼ï¼š
- CSS å˜é‡å®šä¹‰ï¼ˆä¸»é¢˜è‰²ã€é˜´å½±ã€è¿‡æ¸¡ç­‰ï¼‰
- é‡ç½®æ ·å¼
- é€šç”¨å·¥å…·ç±»

---

### å‰ç«¯æºç  (`src/`)

#### `main.js` - åº”ç”¨å…¥å£
```javascript
// åŠŸèƒ½ï¼š
// 1. åˆ›å»º Vue åº”ç”¨å®ä¾‹
// 2. é…ç½® Vue Router è·¯ç”±
// 3. æŒ‚è½½åº”ç”¨åˆ° DOM

// è·¯ç”±é…ç½®ï¼š
// /          -> WelcomePage (æ¬¢è¿é¡µ)
// /login     -> UserLoginPage (ç™»å½•é¡µ)
// /user-profile -> UserProfilePage (ç”¨æˆ·ç®¡ç†)
// /app       -> AnalysisPage (åˆ†æé¡µ)
```

#### `App.vue` - æ ¹ç»„ä»¶
æœ€ç®€å•çš„æ ¹ç»„ä»¶ï¼ŒåªåŒ…å« `<router-view />` ç”¨äºæ¸²æŸ“è·¯ç”±é¡µé¢ã€‚

---

### é¡µé¢ç»„ä»¶ (`src/views/`)

#### `WelcomePage.vue` - æ¬¢è¿é¡µ
**åŠŸèƒ½æ¨¡å—ï¼š**
- èƒŒæ™¯å›¾ç‰‡è½®æ’­ï¼ˆ3å¼ å›¾ç‰‡ï¼Œ5ç§’åˆ‡æ¢ï¼‰
- å·¥å…·æ å¿«æ·é“¾æ¥ï¼ˆå¯é…ç½®ï¼‰
- ç”¨æˆ·å¤´åƒæŒ‰é’®ï¼ˆè·³è½¬ä¸ªäººé¡µ/ç™»å½•é¡µï¼‰
- å†å²è®°å½•æŒ‰é’®ï¼ˆè·³è½¬åˆ†æé¡µå¹¶æ‰“å¼€å†å²é¢æ¿ï¼‰
- "å¼€å§‹ä½¿ç”¨"æŒ‰é’®
- "æ›´å¤šå…è´¹æ¨¡å‹"æŒ‰é’®ï¼ˆä»…ç™»å½•åæ˜¾ç¤ºï¼‰

**å…³é”®ä»£ç ï¼š**
```javascript
// å·¥å…·æ é…ç½® - ä¿®æ”¹è¿™é‡Œæ·»åŠ /åˆ é™¤å¿«æ·æ–¹å¼
const toolbarItems = ref([
  { name: 'åç§°', icon: 'ğŸµ', url: 'https://...' }
])

// æ›´å¤šæ¨¡å‹é“¾æ¥ - ä¿®æ”¹è¿™é‡Œæ›´æ¢è·³è½¬åœ°å€
const moreModelsUrl = 'https://...'
```

#### `UserLoginPage.vue` - ç™»å½•/æ³¨å†Œé¡µ
**åŠŸèƒ½æ¨¡å—ï¼š**
- ç™»å½•/æ³¨å†Œè¡¨å•åˆ‡æ¢
- è¡¨å•éªŒè¯ï¼ˆç”¨æˆ·åã€å¯†ç ã€ç¡®è®¤å¯†ç ï¼‰
- è°ƒç”¨åç«¯ API è¿›è¡Œè®¤è¯
- èƒŒæ™¯å›¾ç‰‡è½®æ’­

**å…³é”®é€»è¾‘ï¼š**
```javascript
// ç™»å½•æµç¨‹
await login(username, password)  // è°ƒç”¨ userApi
router.push('/user-profile')     // è·³è½¬ç”¨æˆ·ç®¡ç†é¡µ

// æ³¨å†Œæµç¨‹
await register(username, password)
router.push('/user-profile')
```

#### `UserProfilePage.vue` - ç”¨æˆ·ç®¡ç†é¡µ
**åŠŸèƒ½æ¨¡å—ï¼š**
- å¤´åƒä¸Šä¼ ï¼ˆç‚¹å‡»é€‰æ‹©å›¾ç‰‡ï¼Œè½¬ base64ï¼‰
- æ˜µç§°ã€é‚®ç®±ç¼–è¾‘
- å†å²è®°å½•åˆ—è¡¨ï¼ˆç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰
- åˆ‡æ¢è´¦å·åŠŸèƒ½
- å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹å™¨

**å…³é”®é€»è¾‘ï¼š**
```javascript
// ä¿å­˜ç”¨æˆ·ä¿¡æ¯
await updateUserInfo({ nickname, avatar, email })

// åŠ è½½å†å²è®°å½•
const records = await getHistoryFromServer()
```

#### `AnalysisPage.vue` - å›¾ç‰‡åˆ†æé¡µï¼ˆæ ¸å¿ƒé¡µé¢ï¼‰
**åŠŸèƒ½æ¨¡å—ï¼š**
1. **å›¾ç‰‡ä¸Šä¼ **
   - ç‚¹å‡»ä¸Šä¼  / æ‹–æ‹½ä¸Šä¼ 
   - æ–‡ä»¶ç±»å‹éªŒè¯ (JPG/PNG/WebP)
   - æ–‡ä»¶å¤§å°é™åˆ¶ (10MB)

2. **AI åˆ†æ**
   - è°ƒç”¨è±†åŒ…è§†è§‰æ¨¡å‹ API
   - æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
   - é”™è¯¯å¤„ç†å’Œé‡è¯•

3. **ç»“æœå±•ç¤º**
   - åŸå›¾ä¸åˆ†æå›¾å¯¹æ¯”
   - Canvas ç»˜åˆ¶æ„å›¾è¾…åŠ©çº¿
   - å…­ç»´åº¦åˆ†æå¡ç‰‡

4. **å†å²è®°å½•**
   - ä¾§è¾¹é¢æ¿æ˜¾ç¤º
   - ä¿å­˜/åˆ é™¤/æ¢å¤åŠŸèƒ½
   - æœ€å¤š50æ¡è®°å½•

5. **å›¾ç‰‡æŸ¥çœ‹å™¨**
   - ç‚¹å‡»å›¾ç‰‡æ”¾å¤§
   - æ»šè½®ç¼©æ”¾
   - ç¼©æ”¾æ§åˆ¶æŒ‰é’®

**å…³é”®é€»è¾‘ï¼š**
```javascript
// åˆ†ææµç¨‹
const result = await analyzeImage(base64Image)  // è°ƒç”¨ AI API
drawCompositionLines(canvas, image, result.composition.lines)  // ç»˜åˆ¶æ„å›¾çº¿

// ä¿å­˜å†å²
await addHistoryToServer(imageData, analysisImage, result)
```

---

### å·¥å…·å‡½æ•° (`src/utils/`)

#### `api.js` - AI åˆ†æ API
**å¯¼å‡ºå‡½æ•°ï¼š**

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `setApiKey(key)` | è®¾ç½® API å¯†é’¥ |
| `getApiKey()` | è·å–å½“å‰ API å¯†é’¥ |
| `buildRequestBody(base64Image)` | æ„å»º API è¯·æ±‚ä½“ |
| `parseAnalysisResult(content)` | è§£æ AI è¿”å›çš„ JSON |
| `analyzeImage(base64Image)` | è°ƒç”¨ AI åˆ†æå›¾ç‰‡ |
| `drawCompositionLines(canvas, image, lines)` | åœ¨ Canvas ä¸Šç»˜åˆ¶æ„å›¾çº¿ |
| `compressImage(base64Image, maxWidth)` | å‹ç¼©å›¾ç‰‡ |
| `getErrorMessage(error)` | è½¬æ¢é”™è¯¯ä¸ºå‹å¥½æç¤º |

**AI åˆ†æè¿”å›ç»“æ„ï¼š**
```javascript
{
  composition: {
    type: "ä¸‰åˆ†æ³•",
    lines: [{ startX, startY, endX, endY, color }],
    description: "æ„å›¾åˆ†ææè¿°"
  },
  lighting: "å…‰çº¿åˆ†æ",
  color: "è‰²å½©åˆ†æ",
  subject: "ä¸»ä½“è¡¨è¾¾åˆ†æ",
  perspective: "æ™¯åˆ«ä¸è§’åº¦åˆ†æ",
  improvement: "ä¸è¶³ä¸æå‡å»ºè®®"
}
```

#### `userApi.js` - ç”¨æˆ·è®¤è¯ API
**å¯¼å‡ºå‡½æ•°ï¼š**

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `getToken()` | è·å–å­˜å‚¨çš„ token |
| `setToken(token)` | è®¾ç½® token |
| `clearToken()` | æ¸…é™¤ token |
| `getCachedUser()` | è·å–ç¼“å­˜çš„ç”¨æˆ·æ•°æ® |
| `register(username, password)` | ç”¨æˆ·æ³¨å†Œ |
| `login(username, password)` | ç”¨æˆ·ç™»å½• |
| `logout()` | ç”¨æˆ·ç™»å‡º |
| `verifyAuth()` | éªŒè¯ç™»å½•çŠ¶æ€ |
| `isLoggedIn()` | æ£€æŸ¥æ˜¯å¦å·²ç™»å½• |
| `getUserInfo()` | è·å–ç”¨æˆ·ä¿¡æ¯ |
| `updateUserInfo(userInfo)` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ |
| `getHistoryRecords()` | è·å–å†å²è®°å½• |
| `addHistoryRecord(...)` | æ·»åŠ å†å²è®°å½• |
| `deleteHistoryRecord(id)` | åˆ é™¤å†å²è®°å½• |

#### `userStorage.js` - æœ¬åœ°å­˜å‚¨å·¥å…·
æä¾›çº¯æœ¬åœ°å­˜å‚¨æ–¹æ¡ˆï¼ˆä¸ä¾èµ–åç«¯ï¼‰ï¼ŒåŒ…å«ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æ•°æ®å¯¼å…¥å¯¼å‡ºç­‰åŠŸèƒ½ã€‚
ç›®å‰ä¸»è¦ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼Œå®é™…ä½¿ç”¨ `userApi.js` è¿æ¥åç«¯ã€‚

---

### åç«¯æœåŠ¡ (`server/`)

#### `server/index.js` - Express æœåŠ¡å™¨
**æŠ€æœ¯æ ˆï¼š**
- Express.js - Web æ¡†æ¶
- better-sqlite3 - SQLite æ•°æ®åº“
- bcryptjs - å¯†ç åŠ å¯†
- uuid - ç”Ÿæˆå”¯ä¸€ ID

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**
```sql
-- ç”¨æˆ·è¡¨
users (id, username, password, nickname, avatar, email, created_at)

-- ä¼šè¯è¡¨ï¼ˆå®ç°å•è®¾å¤‡ç™»å½•ï¼‰
sessions (id, user_id, token, device_info, created_at)

-- å†å²è®°å½•è¡¨
history (id, user_id, record_id, image_data, analysis_image, result, created_at)
```

**API ç«¯ç‚¹ï¼š**

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/register` | POST | ç”¨æˆ·æ³¨å†Œ |
| `/api/login` | POST | ç”¨æˆ·ç™»å½•ï¼ˆä¼šåˆ é™¤æ—§ä¼šè¯ï¼‰ |
| `/api/logout` | POST | ç”¨æˆ·ç™»å‡º |
| `/api/verify` | GET | éªŒè¯ token |
| `/api/user` | GET | è·å–ç”¨æˆ·ä¿¡æ¯ |
| `/api/user` | PUT | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ |
| `/api/history` | GET | è·å–å†å²è®°å½• |
| `/api/history` | POST | æ·»åŠ å†å²è®°å½• |
| `/api/history/:id` | DELETE | åˆ é™¤å†å²è®°å½• |
| `/api/history/cleanup` | POST | æ¸…ç†è¿‡æœŸè®°å½• |

**è®¤è¯æœºåˆ¶ï¼š**
- ä½¿ç”¨ Bearer Token è®¤è¯
- ç™»å½•æ—¶ç”Ÿæˆ UUID token
- åŒä¸€ç”¨æˆ·ç™»å½•ä¼šåˆ é™¤æ—§ä¼šè¯ï¼ˆå•è®¾å¤‡é™åˆ¶ï¼‰
- Token å­˜å‚¨åœ¨ localStorage

---

## æ•°æ®æµ

### å›¾ç‰‡åˆ†ææµç¨‹
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
    â†“
FileReader è½¬ base64
    â†“
è°ƒç”¨ analyzeImage() â†’ è±†åŒ… API
    â†“
è§£æè¿”å›çš„ JSON
    â†“
Canvas ç»˜åˆ¶æ„å›¾çº¿
    â†“
æ˜¾ç¤ºåˆ†æç»“æœ
    â†“
ç”¨æˆ·ç‚¹å‡»ä¿å­˜ â†’ åç«¯ API â†’ SQLite
```

### ç”¨æˆ·è®¤è¯æµç¨‹
```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
    â†“
è°ƒç”¨ login() â†’ åç«¯ /api/login
    â†“
åç«¯éªŒè¯å¯†ç  (bcrypt)
    â†“
åˆ é™¤æ—§ä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯
    â†“
è¿”å› token + ç”¨æˆ·ä¿¡æ¯
    â†“
å‰ç«¯å­˜å‚¨ token åˆ° localStorage
    â†“
åç»­è¯·æ±‚æºå¸¦ Authorization header
```

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„åˆ†æç»´åº¦
1. ä¿®æ”¹ `api.js` ä¸­çš„ promptï¼Œæ·»åŠ æ–°å­—æ®µ
2. ä¿®æ”¹ `parseAnalysisResult()` éªŒè¯æ–°å­—æ®µ
3. åœ¨ `AnalysisPage.vue` æ·»åŠ æ–°çš„åˆ†æå¡ç‰‡

### æ·»åŠ æ–°é¡µé¢
1. åœ¨ `src/views/` åˆ›å»ºæ–°ç»„ä»¶
2. åœ¨ `main.js` æ·»åŠ è·¯ç”±é…ç½®
3. åœ¨éœ€è¦çš„åœ°æ–¹æ·»åŠ å¯¼èˆªé“¾æ¥

### æ›´æ¢ AI æ¨¡å‹
ä¿®æ”¹ `api.js` ä¸­çš„ `API_CONFIG`ï¼š
```javascript
const API_CONFIG = {
  baseUrl: 'æ–°çš„APIåœ°å€',
  model: 'æ–°çš„æ¨¡å‹åç§°',
  apiKey: 'æ–°çš„APIå¯†é’¥'
}
```
åŒæ—¶å¯èƒ½éœ€è¦è°ƒæ•´ `buildRequestBody()` å’Œ `parseAnalysisResult()` ä»¥é€‚é…æ–°æ¨¡å‹çš„è¯·æ±‚/å“åº”æ ¼å¼ã€‚
