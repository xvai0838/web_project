const g="/api",c="auth_token",i="current_user_data";function u(){return localStorage.getItem(c)}function y(t){localStorage.setItem(c,t)}function d(){localStorage.removeItem(c),localStorage.removeItem(i)}function l(){const t=localStorage.getItem(i);return t?JSON.parse(t):null}function o(t){localStorage.setItem(i,JSON.stringify(t))}async function s(t,r={}){const e=u(),f={"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{},...r.headers};try{const a=await fetch(`${g}${t}`,{...r,headers:f}),n=await a.json();if(!a.ok)throw n.code==="SESSION_INVALID"&&(d(),window.dispatchEvent(new CustomEvent("session-invalid"))),new Error(n.error||"请求失败");return n}catch(a){throw a.message==="Failed to fetch"?new Error("网络连接失败，请检查网络"):a}}async function h(t,r){const e=await s("/register",{method:"POST",body:JSON.stringify({username:t,password:r})});return e.success&&(y(e.token),o(e.user)),e}async function S(t,r){const e=await s("/login",{method:"POST",body:JSON.stringify({username:t,password:r})});return e.success&&(y(e.token),o(e.user)),e}async function w(){try{await s("/logout",{method:"POST"})}catch{}d()}async function m(){if(!u())return{success:!1};try{const t=await s("/verify");return t.success&&o(t.user),t}catch(t){return d(),{success:!1,error:t.message}}}function E(){return!!u()}async function I(t){const r=await s("/user",{method:"PUT",body:JSON.stringify(t)});return r.success&&o(r.user),r}async function O(){const t=await s("/history");return t.success?t.records:[]}async function T(t,r,e){return await s("/history",{method:"POST",body:JSON.stringify({imageData:t,analysisImage:r,result:e})})}async function N(t){return await s(`/history/${t}`,{method:"DELETE"})}export{O as a,w as b,T as c,N as d,l as g,E as i,S as l,h as r,I as u,m as v};
