import{_ as he,r,o as ye,u as we,j as _e,a as ke,c as m,b as t,d as b,t as f,F as be,e as Ce,w as x,g as Ie,i as Se,n as Re,k as G,f as p}from"./index-D_xQVRzG.js";import{i as q,v as xe,g as Ae,a as De,c as Pe,d as $e}from"./userApi-_ZDq3u6c.js";const j={baseUrl:"https://ark.cn-beijing.volces.com/api/v3/chat/completions",model:"doubao-seed-1-6-vision-250815",apiKey:"f2960b31-1afa-4331-8e74-acbcfd554938"};function Te(l){const n=l.startsWith("data:")?l:`data:image/jpeg;base64,${l}`;return{model:j.model,messages:[{role:"user",content:[{type:"image_url",image_url:{url:n}},{type:"text",text:`è¯·åˆ†æè¿™å¼ æ‘„å½±å›¾ç‰‡ï¼Œå¹¶ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
{
  "composition": {
    "type": "æ„å›¾ç±»å‹ï¼ˆå¦‚ä¸‰åˆ†æ³•ã€å¯¹è§’çº¿ã€ä¸­å¿ƒæ„å›¾ç­‰ï¼‰",
    "lines": [
      {"startX": èµ·ç‚¹Xç™¾åˆ†æ¯”0-100, "startY": èµ·ç‚¹Yç™¾åˆ†æ¯”0-100, "endX": ç»ˆç‚¹Xç™¾åˆ†æ¯”0-100, "endY": ç»ˆç‚¹Yç™¾åˆ†æ¯”0-100, "color": "çº¿æ¡é¢œè‰²"}
    ],
    "description": "æ„å›¾åˆ†ææè¿°"
  },
  "lighting": "å…‰çº¿åˆ†æ",
  "color": "è‰²å½©åˆ†æ",
  "subject": "ä¸»ä½“è¡¨è¾¾åˆ†æ",
  "perspective": "æ™¯åˆ«ä¸è§’åº¦åˆ†æ",
  "improvement": "ä¸è¶³ä¸æå‡å»ºè®®ï¼ˆæŒ‡å‡ºç…§ç‰‡çš„ä¸è¶³ä¹‹å¤„ï¼Œå¹¶ç»™å‡ºå…·ä½“çš„æ”¹è¿›å»ºè®®ï¼‰"
}`}]}]}}function He(l){const n=l.match(/\{[\s\S]*\}/);if(!n)throw new Error("æ— æ³•ä»å“åº”ä¸­è§£æJSONç»“æœ");const d=JSON.parse(n[0]),a=["composition","lighting","color","subject","perspective","improvement"];for(const u of a)if(!(u in d))throw new Error(`åˆ†æç»“æœç¼ºå°‘å¿…è¦å­—æ®µ: ${u}`);return d}async function Le(l){const n=Te(l),d=await fetch(j.baseUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j.apiKey}`},body:JSON.stringify(n)});if(!d.ok)throw d.status===401?new Error("APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ"):d.status===429?new Error("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•"):d.status>=500?new Error("æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"):new Error(`APIè¯·æ±‚å¤±è´¥: ${d.status}`);const a=await d.json();if(!a.choices||!a.choices[0]||!a.choices[0].message)throw new Error("APIå“åº”æ ¼å¼é”™è¯¯");const u=a.choices[0].message.content;return He(u)}function Ee(l,n,d){if(!l||!n||!d)return;const a=l.getContext("2d");l.width=n.naturalWidth||n.width,l.height=n.naturalHeight||n.height,a.drawImage(n,0,0,l.width,l.height),a.lineWidth=5,a.lineCap="round";for(const u of d){const v=u.startX/100*l.width,C=u.startY/100*l.height,h=u.endX/100*l.width,c=u.endY/100*l.height;a.strokeStyle=u.color||"#ff0000",a.beginPath(),a.moveTo(v,C),a.lineTo(h,c),a.stroke()}}const Me=400;function K(l,n=Me){return new Promise(d=>{const a=new Image;a.onload=()=>{const u=document.createElement("canvas");let v=a.width,C=a.height;v>n&&(C=C*n/v,v=n),u.width=v,u.height=C,u.getContext("2d").drawImage(a,0,0,v,C);const c=u.toDataURL("image/jpeg",.6);d(c)},a.onerror=()=>{d(l)},a.src=l})}function Ne(l){const n=l.message||String(l);return n.includes("Failed to fetch")||n.includes("NetworkError")||n.includes("network")?"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•":n.includes("APIå¯†é’¥")||n.includes("401")||n.includes("Unauthorized")?"APIé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥å¯†é’¥è®¾ç½®":n.includes("timeout")||n.includes("è¶…æ—¶")?"åˆ†æè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•":n.includes("JSON")||n.includes("è§£æ")?"åˆ†æç»“æœè§£æå¤±è´¥ï¼Œè¯·é‡è¯•":n.includes("429")||n.includes("é¢‘ç¹")?"è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•":n.includes("500")||n.includes("æœåŠ¡å™¨")?"æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•":n.includes("è¯·")||n.includes("é”™è¯¯")?n:"åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•"}const je={class:"analysis-page"},Ue=["src"],Oe={key:1,class:"avatar-placeholder"},Xe={key:0,class:"history-panel"},Ye={class:"history-header"},ze={class:"history-list"},Fe={key:0,class:"empty-tip"},Be=["src","onClick"],Je=["onClick"],Ve={class:"history-type"},We={class:"history-time"},Ge=["onClick"],qe={class:"main-content"},Ke={key:0,class:"welcome-text"},Ze={key:1,class:"loading-area"},Qe={key:2,class:"result-area"},et={class:"image-comparison"},tt={class:"image-box"},st=["src"],nt={class:"image-box"},at={key:0,class:"analysis-text"},lt={class:"analysis-item","data-dimension":"composition"},ot={key:0},it={class:"analysis-item","data-dimension":"lighting"},rt={class:"analysis-item","data-dimension":"color"},ut={class:"analysis-item","data-dimension":"subject"},ct={class:"analysis-item","data-dimension":"perspective"},dt={class:"analysis-item","data-dimension":"improvement"},vt={class:"action-buttons"},gt=["disabled"],mt={key:3,class:"error-area"},ft={class:"error-text"},pt={class:"image-viewer-content"},ht={class:"viewer-controls"},yt=["disabled"],wt=["disabled"],_t=["src"],Z=50,kt={__name:"AnalysisPage",setup(l){const n=we(),d=_e(),a=r(""),u=r(""),v=r(null),C=r(null),h=r(null),c=r(null),I=r(null),i=r(null),D=r(!1),$=r(!1),y=r(null),S=r(!1),U=r(!1),P=r([]),w=r(!1),R=r(null),A=r(!1),H=r(!1),L=r(""),_=r(1),Q=r(null);function E(s){L.value=s,_.value=1,H.value=!0}function O(){H.value=!1,L.value=""}function X(){_.value<3&&(_.value=Math.min(3,_.value+.25))}function Y(){_.value>.5&&(_.value=Math.max(.5,_.value-.25))}function ee(){_.value=1}function te(s){s.deltaY<0?X():Y()}function se(){q()?n.push("/user-profile"):n.push("/login")}function ne(){n.push("/")}function M(){return Z}function ae(){return P.value.length<Z}function z(){alert("æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•"),n.push("/login")}ye(async()=>{if(window.addEventListener("session-invalid",z),!q()){n.push("/login");return}try{if(!(await xe()).success){n.push("/login");return}const e=Ae();e&&(a.value=e.avatar||"",u.value=e.nickname||e.username),await N(),d.query.showHistory==="true"&&(S.value=!0)}catch(s){console.error("åˆå§‹åŒ–å¤±è´¥:",s)}}),ke(()=>{window.removeEventListener("session-invalid",z)});async function N(){try{const s=await De();P.value=s.sort((e,o)=>o.timestamp-e.timestamp)}catch(s){console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:",s)}}function le(s){const e=new Date(s),o=e.getMonth()+1,k=e.getDate(),g=e.getHours().toString().padStart(2,"0"),T=e.getMinutes().toString().padStart(2,"0");return`${o}æœˆ${k}æ—¥ ${g}:${T}`}function oe(s){c.value=s.imageData,I.value=s.analysisImage,i.value=s.result,S.value=!1,y.value=null,w.value=!0,R.value=s.id,G(()=>{if(h.value&&s.analysisImage){const e=new Image;e.onload=()=>{const o=h.value.getContext("2d");h.value.width=e.width,h.value.height=e.height,o.drawImage(e,0,0)},e.src=s.analysisImage}})}function ie(){var s;(s=v.value)==null||s.click()}function re(){$.value=!0}function ue(){$.value=!1}function ce(s){var o;$.value=!1;const e=(o=s.dataTransfer)==null?void 0:o.files;e&&e.length>0&&F(e[0])}function de(s){var o;const e=(o=s.target)==null?void 0:o.files;e&&e.length>0&&F(e[0])}function F(s){if(!["image/jpeg","image/png","image/webp"].includes(s.type)){y.value="è¯·ä¸Šä¼ JPGã€PNGæˆ–WebPæ ¼å¼çš„å›¾ç‰‡";return}if(s.size>10*1024*1024){y.value="å›¾ç‰‡å¤§å°è¶…è¿‡é™åˆ¶ï¼Œè¯·å‹ç¼©åé‡è¯•";return}console.log("å¤„ç†æ–°æ–‡ä»¶ï¼Œé‡ç½®æ‰€æœ‰çŠ¶æ€"),y.value=null,w.value=!1,R.value=null,I.value=null,i.value=null;const o=new FileReader;o.onload=k=>{c.value=k.target.result,console.log("æ–‡ä»¶è¯»å–å®Œæˆï¼ŒisSaved:",w.value),ve()},o.onerror=()=>{y.value="å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©"},o.readAsDataURL(s)}async function ve(){D.value=!0,y.value=null;try{const s=await Le(c.value);i.value=s,w.value=!1,R.value=null,I.value=null,console.log("åˆ†æå®Œæˆï¼ŒisSaved:",w.value,"analysisResult:",!!i.value),await G(),await new Promise(e=>setTimeout(e,100)),await B()}catch(s){y.value=Ne(s),i.value=null}finally{D.value=!1}}function B(){return new Promise(s=>{if(!h.value||!i.value||!c.value){s();return}const e=new Image;e.onload=()=>{var k;const o=((k=i.value.composition)==null?void 0:k.lines)||[];Ee(h.value,e,o);try{I.value=h.value.toDataURL("image/png"),console.log("åˆ†æå›¾æ•°æ®å·²ç”Ÿæˆ")}catch(g){console.error("æ— æ³•è·å–åˆ†æå›¾æ•°æ®:",g)}s()},e.onerror=()=>{console.error("å›¾ç‰‡åŠ è½½å¤±è´¥"),s()},e.src=c.value})}function ge(){U.value=!0,i.value&&B()}async function me(s){if(confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ"))try{await $e(s),await N(),R.value===s&&(R.value=null,w.value=!1)}catch(e){alert("åˆ é™¤å¤±è´¥: "+e.message)}}async function fe(){if(console.log("saveToHistory è¢«è°ƒç”¨"),!i.value||!c.value){console.log("ä¿å­˜æ¡ä»¶ä¸æ»¡è¶³: ç¼ºå°‘åˆ†æç»“æœæˆ–å›¾ç‰‡");return}if(w.value||A.value)return;if(!ae()){const e=M();alert(`å†å²è®°å½•å·²è¾¾ä¸Šé™(${e}æ¡)ï¼Œè¯·å…ˆåœ¨å†å²è®°å½•é¢æ¿ä¸­åˆ é™¤æ—§è®°å½•åå†ä¿å­˜ã€‚`),S.value=!0;return}let s=I.value;if(!s&&h.value)try{s=h.value.toDataURL("image/png")}catch(e){console.error("è·å–åˆ†æå›¾å¤±è´¥:",e),s=c.value}s||(s=c.value),A.value=!0,y.value=null;try{const e=await K(c.value),o=await K(s),k=await Pe(e,o,i.value);R.value=k.record.id,w.value=!0,I.value=s,await N(),console.log("ä¿å­˜æˆåŠŸ:",k.record.id)}catch(e){console.error("ä¿å­˜å¤±è´¥:",e),e.message.includes("ä¸Šé™")?(alert(`å†å²è®°å½•å·²è¾¾ä¸Šé™(${M()}æ¡)ï¼Œè¯·å…ˆåˆ é™¤æ—§è®°å½•ã€‚`),S.value=!0):y.value="ä¿å­˜å¤±è´¥: "+e.message}finally{A.value=!1}}function pe(){var s;console.log("ç»§ç»­ä¸Šä¼ è¢«ç‚¹å‡»ï¼Œé‡ç½®çŠ¶æ€"),w.value=!1,A.value=!1,R.value=null,v.value&&(v.value.value=""),(s=v.value)==null||s.click()}function J(){c.value=null,I.value=null,i.value=null,y.value=null,U.value=!1,w.value=!1,R.value=null,v.value&&(v.value.value="")}return(s,e)=>{var o,k;return p(),m("div",je,[t("button",{class:"back-btn",onClick:ne}," â† è¿”å› "),t("button",{class:"history-btn",onClick:e[0]||(e[0]=g=>S.value=!S.value)}," ğŸ“‹ å†å²è®°å½• "),t("div",{class:"profile-btn",onClick:se},[a.value?(p(),m("img",{key:0,src:a.value,alt:"å¤´åƒ",class:"avatar-img"},null,8,Ue)):(p(),m("span",Oe,"ğŸ‘¤"))]),S.value?(p(),m("div",Xe,[t("div",Ye,[t("h3",null,"å†å²è®°å½• ("+f(P.value.length)+"/"+f(M())+")",1),t("button",{class:"close-btn",onClick:e[1]||(e[1]=g=>S.value=!1)},"Ã—")]),t("div",ze,[P.value.length===0?(p(),m("p",Fe,"æš‚æ— å†å²è®°å½•")):b("",!0),(p(!0),m(be,null,Ce(P.value,g=>{var T,V;return p(),m("div",{key:g.id,class:"history-item"},[t("img",{src:g.imageData,alt:"å†å²å›¾ç‰‡",class:"history-thumb",onClick:x(W=>E(g.imageData),["stop"])},null,8,Be),t("div",{class:"history-info",onClick:W=>oe(g)},[t("p",Ve,f(((V=(T=g.result)==null?void 0:T.composition)==null?void 0:V.type)||"æœªçŸ¥æ„å›¾"),1),t("p",We,f(le(g.timestamp)),1)],8,Je),t("button",{class:"delete-history-btn",onClick:x(W=>me(g.id),["stop"]),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,Ge)])}),128))])])):b("",!0),t("div",qe,[t("input",{type:"file",ref_key:"fileInput",ref:v,accept:"image/jpeg,image/png,image/webp",onChange:de,style:{display:"none"}},null,544),!c.value&&!D.value?(p(),m("div",{key:0,class:Ie(["upload-area",{"drag-over":$.value}]),onClick:ie,onDragover:x(re,["prevent"]),onDragleave:x(ue,["prevent"]),onDrop:x(ce,["prevent"])},[u.value?(p(),m("p",Ke,"æ¬¢è¿ï¼Œ"+f(u.value),1)):b("",!0),e[4]||(e[4]=t("div",{class:"upload-icon"},"ğŸ“·",-1)),e[5]||(e[5]=t("p",{class:"upload-text"},"ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡",-1)),e[6]||(e[6]=t("p",{class:"upload-hint"},"æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼",-1))],34)):b("",!0),D.value?(p(),m("div",Ze,[...e[7]||(e[7]=[t("div",{class:"loading-content"},[t("div",{class:"loading-spinner"}),t("p",{class:"loading-text"},"æ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œè¯·ç¨å€™..."),t("p",{class:"loading-hint"},"AI æ­£åœ¨è¯†åˆ«æ„å›¾ã€å…‰çº¿ã€è‰²å½©ç­‰ä¿¡æ¯")],-1)])])):b("",!0),c.value&&!D.value?(p(),m("div",Qe,[t("div",et,[t("div",tt,[e[8]||(e[8]=t("h4",null,"åŸå›¾",-1)),t("img",{src:c.value,alt:"åŸå›¾",ref_key:"originalImage",ref:C,onLoad:ge,onClick:e[2]||(e[2]=g=>E(c.value)),class:"clickable-image"},null,40,st)]),t("div",nt,[e[9]||(e[9]=t("h4",null,"åˆ†æå›¾",-1)),t("div",{class:"canvas-container",onClick:e[3]||(e[3]=g=>E(I.value||c.value))},[t("canvas",{ref_key:"analysisCanvas",ref:h,class:"clickable-image"},null,512)])])]),i.value?(p(),m("div",at,[t("div",lt,[e[11]||(e[11]=t("h4",null,"ğŸ“ æ„å›¾åˆ†æ",-1)),(o=i.value.composition)!=null&&o.type?(p(),m("p",ot,[e[10]||(e[10]=t("strong",null,"ç±»å‹ï¼š",-1)),Se(f(i.value.composition.type),1)])):b("",!0),t("p",null,f(((k=i.value.composition)==null?void 0:k.description)||"æš‚æ— æ„å›¾åˆ†æ"),1)]),t("div",it,[e[12]||(e[12]=t("h4",null,"ğŸ’¡ å…‰çº¿åˆ†æ",-1)),t("p",null,f(i.value.lighting||"æš‚æ— å…‰çº¿åˆ†æ"),1)]),t("div",rt,[e[13]||(e[13]=t("h4",null,"ğŸ¨ è‰²å½©åˆ†æ",-1)),t("p",null,f(i.value.color||"æš‚æ— è‰²å½©åˆ†æ"),1)]),t("div",ut,[e[14]||(e[14]=t("h4",null,"ğŸ¯ ä¸»ä½“è¡¨è¾¾",-1)),t("p",null,f(i.value.subject||"æš‚æ— ä¸»ä½“è¡¨è¾¾åˆ†æ"),1)]),t("div",ct,[e[15]||(e[15]=t("h4",null,"ğŸ“· æ™¯åˆ«ä¸è§’åº¦",-1)),t("p",null,f(i.value.perspective||"æš‚æ— æ™¯åˆ«ä¸è§’åº¦åˆ†æ"),1)]),t("div",dt,[e[16]||(e[16]=t("h4",null,"ğŸ’¡ ä¸è¶³ä¸æå‡",-1)),t("p",null,f(i.value.improvement||"æš‚æ— æ”¹è¿›å»ºè®®"),1)])])):b("",!0),t("div",vt,[t("button",{class:"save-btn",onClick:fe,disabled:w.value||!i.value||A.value},f(A.value?"ä¿å­˜ä¸­...":w.value?"âœ“ å·²ä¿å­˜":"ğŸ’¾ ä¿å­˜åˆ°å†å²"),9,gt),t("button",{class:"continue-btn",onClick:pe},"ğŸ“· ç»§ç»­ä¸Šä¼ "),t("button",{class:"reset-btn",onClick:J},"é‡æ–°å¼€å§‹")])])):b("",!0),y.value?(p(),m("div",mt,[t("p",ft,f(y.value),1),t("button",{class:"retry-btn",onClick:J},"é‡è¯•")])):b("",!0)]),H.value?(p(),m("div",{key:1,class:"image-viewer-modal",onClick:x(O,["self"])},[t("div",pt,[t("button",{class:"viewer-close-btn",onClick:O},"Ã—"),t("div",ht,[t("button",{onClick:Y,disabled:_.value<=.5},"âˆ’",8,yt),t("span",null,f(Math.round(_.value*100))+"%",1),t("button",{onClick:X,disabled:_.value>=3},"+",8,wt),t("button",{onClick:ee},"é‡ç½®")]),t("div",{class:"viewer-image-container",ref_key:"viewerContainer",ref:Q},[t("img",{src:L.value,style:Re({transform:`scale(${_.value})`}),onWheel:x(te,["prevent"]),draggable:"false"},null,44,_t)],512)])])):b("",!0)])}}},It=he(kt,[["__scopeId","data-v-4bc1a6c9"]]);export{It as default};
